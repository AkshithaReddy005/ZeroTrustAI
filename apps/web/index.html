<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõ°Ô∏è ZeroTrust-AI SOC (React)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @keyframes pulse-red { 0%,100%{ background-color: rgba(239,68,68,.08);} 50%{ background-color: rgba(239,68,68,.18);} }
    .threat-high { animation: pulse-red 2s infinite; }
    .cyber-grid { background-image: linear-gradient(rgba(59,130,246,.08) 1px,transparent 1px), linear-gradient(90deg, rgba(59,130,246,.08) 1px,transparent 1px); background-size: 50px 50px; }
  </style>
</head>
<body class="bg-gray-900 text-white cyber-grid">
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useRef, useState } = React;
    const API_BASE = 'http://localhost:9000';
    const WS_URL = 'ws://localhost:9000/ws';

    const SeverityBadge = ({severity}) => {
      const color = severity==='high'?'text-red-400 bg-red-900/30':severity==='medium'?'text-yellow-300 bg-yellow-900/30':'text-green-400 bg-green-900/30';
      return <span className={`px-2 py-1 rounded text-xs ${color}`}>{severity.toUpperCase()}</span>;
    };

    const SummaryBar = ({metrics}) => (
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <MetricCard icon="fa-network-wired" title="Total Flows" value={metrics?.total_flows ?? 0} color="text-blue-400" />
        <MetricCard icon="fa-exclamation-triangle" title="Threats Detected" value={metrics?.threats_detected ?? 0} color="text-red-400" />
        <MetricCard icon="fa-ban" title="Blocked" value={metrics?.blocked_flows ?? 0} color="text-orange-400" />
        <MetricCard icon="fa-bullseye" title="Accuracy" value={`${Math.round((metrics?.accuracy ?? 0)*100)}%`} color="text-green-400" />
      </div>
    );

    const MetricCard = ({icon,title,value,color}) => (
      <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-gray-400 text-sm">{title}</p>
            <p className={`text-3xl font-bold ${color}`}>{value}</p>
          </div>
          <i className={`fas ${icon} text-2xl ${color.replace('text-','text-')}`}></i>
        </div>
      </div>
    );

    const ThreatFeed = ({events}) => (
      <div className="bg-gray-800 rounded-lg border border-gray-700">
        <div className="px-4 py-3 border-b border-gray-700 flex justify-between items-center">
          <h2 className="text-lg font-semibold flex items-center"><i className="fas fa-radar text-red-500 mr-2 animate-pulse"></i>Live Threat Detection</h2>
          <span className="text-xs text-gray-400">{events.length} events</span>
        </div>
        <div className="h-96 overflow-y-auto p-4 space-y-3">
          {events.length===0 && (
            <div className="text-center text-gray-500 py-8">
              <i className="fas fa-shield-alt text-4xl mb-3"></i>
              <p>Monitoring network traffic...</p>
              <p className="text-sm">Waiting for threats to detect</p>
            </div>
          )}
          {events.map((t,idx)=> (
            <div key={idx} className={`rounded p-3 border border-gray-700 ${t.severity==='high'?'threat-high':''}`}>
              <div className="flex justify-between items-center">
                <div className="flex items-center space-x-3">
                  <SeverityBadge severity={t.severity||'low'} />
                  <span className="text-sm text-gray-400">{new Date(t.timestamp).toLocaleTimeString()}</span>
                </div>
                <div className="text-xs text-gray-400">Flow: {t.flow_id}</div>
              </div>
              <div className="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                <div><span className="text-gray-400">Label:</span> <span className="font-semibold">{t.label}</span></div>
                <div><span className="text-gray-400">Confidence:</span> {Math.round((t.confidence||0)*100)}%</div>
                <div><span className="text-gray-400">Attack:</span> {t.attack_type||'‚Äî'}</div>
                <div><span className="text-gray-400">Blocked:</span> {t.blocked? 'Yes' : 'No'}</div>
              </div>
              {t.reason?.length>0 && (
                <div className="mt-2 text-xs text-gray-300">Reason: {t.reason.join(', ')}</div>
              )}
            </div>
          ))}
        </div>
      </div>
    );

    const ChartCard = ({title,children}) => (
      <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <h3 className="text-lg font-semibold mb-3 flex items-center"><i className="fas fa-chart-line text-blue-500 mr-2"></i>{title}</h3>
        {children}
      </div>
    );

    const TimelineChart = ({events}) => {
      const canvasRef = useRef(null);
      useEffect(()=>{
        if(!canvasRef.current) return;
        const buckets = {};
        events.forEach(e=>{
          const m = new Date(e.timestamp || Date.now());
          const key = String(m.getHours()).padStart(2,'0')+':'+String(m.getMinutes()).padStart(2,'0');
          buckets[key] = (buckets[key]||0)+1;
        });
        const labels = Object.keys(buckets).sort().slice(-20);
        const data = labels.map(l=>buckets[l]);
        const ctx = canvasRef.current.getContext('2d');
        if(canvasRef.current._chart) { canvasRef.current._chart.destroy(); }
        canvasRef.current._chart = new Chart(ctx, {
          type: 'line', data: { labels, datasets: [{ label: 'Threats/min', data, borderColor: '#60A5FA', tension:.3 }] }, options: { plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#9CA3AF'}}, y:{ticks:{color:'#9CA3AF'}}} }
        });
      }, [events]);
      return <canvas ref={canvasRef} height="200" />;
    };

    const SeverityChart = ({events}) => {
      const canvasRef = useRef(null);
      useEffect(()=>{
        if(!canvasRef.current) return;
        const counts = {high:0, medium:0, low:0};
        events.forEach(e=>{ const s=(e.severity||'low').toLowerCase(); if(counts[s]!==undefined) counts[s]++; });
        const ctx = canvasRef.current.getContext('2d');
        if(canvasRef.current._chart) { canvasRef.current._chart.destroy(); }
        canvasRef.current._chart = new Chart(ctx, {
          type:'pie', data:{ labels:['High','Medium','Low'], datasets:[{ data:[counts.high,counts.medium,counts.low], backgroundColor:['#EF4444','#F59E0B','#10B981'] }] }, options:{ plugins:{legend:{labels:{color:'#E5E7EB'}}} }
        });
      }, [events]);
      return <canvas ref={canvasRef} height="200" />;
    };

    const AttackTypes = ({metrics}) => {
      const types = metrics?.attack_types || {};
      const entries = Object.entries(types);
      return (
        <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
          <h3 className="text-lg font-semibold mb-3 flex items-center"><i className="fas fa-bug text-red-500 mr-2"></i>Attack Types Detected</h3>
          {entries.length===0 ? (
            <p className="text-sm text-gray-400">No attack types detected yet</p>
          ) : (
            <div className="grid grid-cols-2 gap-3">
              {entries.map(([k,v])=> (
                <div key={k} className="bg-gray-700 rounded p-3 text-center">
                  <p className="text-sm font-semibold capitalize">{k.replace('_',' ')}</p>
                  <p className="text-xs text-gray-300">{v} detected</p>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    const Header = ({connected}) => (
      <header className="bg-gray-800 border-b border-blue-500 px-6 py-4">
        <div className="container mx-auto flex justify-between items-center">
          <div className="flex items-center space-x-3">
            <i className="fas fa-shield-alt text-blue-500 text-2xl"></i>
            <h1 className="text-2xl font-bold">ZeroTrust-AI SOC</h1>
          </div>
          <div className="flex items-center space-x-4">
            <span className="flex items-center">
              <span className={`w-3 h-3 ${connected?'bg-green-500':'bg-red-500'} rounded-full mr-2 animate-pulse`}></span>
              <span className="text-sm">{connected? 'Connected' : 'Disconnected'}</span>
            </span>
            <span className="text-sm text-gray-400">{new Date().toLocaleString()}</span>
          </div>
        </div>
      </header>
    );

    const App = () => {
      const [connected, setConnected] = useState(false);
      const [events, setEvents] = useState([]);
      const [metrics, setMetrics] = useState(null);

      useEffect(()=>{
        // Initial load of recent threats
        fetch(`${API_BASE}/threats?limit=50`).then(r=> r.ok? r.json(): []).then(data=> setEvents(Array.isArray(data)? data: [])).catch(()=>{});
        const loadMetrics = ()=> fetch(`${API_BASE}/metrics`).then(r=> r.ok? r.json(): {}).then(setMetrics).catch(()=>{});
        loadMetrics();
        const mt = setInterval(loadMetrics, 2000);
        return ()=> clearInterval(mt);
      }, []);

      useEffect(()=>{
        const ws = new WebSocket(WS_URL);
        ws.onopen = ()=> setConnected(true);
        ws.onclose = ()=> setConnected(false);
        ws.onerror = ()=> setConnected(false);
        ws.onmessage = (ev)=>{
          try{
            const msg = JSON.parse(ev.data);
            if(msg.type==='threat_update' || msg.type==='new_threat'){
              const incoming = Array.isArray(msg.data)? msg.data: [msg.data];
              if(msg.type==='threat_update'){
                setEvents(Array.isArray(msg.data)? msg.data: []);
              } else {
                setEvents(prev => {
                  const seen = new Set(prev.map(e => `${e.flow_id || ''}::${e.timestamp || ''}`));
                  const next = [...prev];
                  incoming.forEach(e => {
                    const k = `${e.flow_id || ''}::${e.timestamp || ''}`;
                    if(!seen.has(k)){
                      next.push(e);
                      seen.add(k);
                    }
                  });
                  return next.slice(-200); // keep last 200
                });
              }
            }
          }catch(e){ /* ignore */ }
        };
        return ()=> ws.close();
      }, []);

      return (
        <>
          <Header connected={connected} />
          <main className="container mx-auto px-6 py-6">
            <SummaryBar metrics={metrics} />
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2"><ThreatFeed events={events} /></div>
              <div className="space-y-6">
                <ChartCard title="Threat Timeline"><TimelineChart events={events} /></ChartCard>
                <ChartCard title="Severity Distribution"><SeverityChart events={events} /></ChartCard>
              </div>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
              <AttackTypes metrics={metrics} />
              <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 className="text-lg font-semibold mb-3 flex items-center"><i className="fas fa-server text-purple-500 mr-2"></i>System Health</h3>
                <p className="text-sm text-gray-300">Active Connections: {metrics?.active_connections ?? 0}</p>
              </div>
            </div>
          </main>
        </>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
