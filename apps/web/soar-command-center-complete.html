<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ¤– SOAR Command Center - ZeroTrust-AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @keyframes pulse-red {
      0%, 100% { background-color: rgba(239, 68, 68, .1); }
      50% { background-color: rgba(239, 68, 68, .2); }
    }
    @keyframes pulse-green {
      0%, 100% { background-color: rgba(34, 197, 94, .1); }
      50% { background-color: rgba(34, 197, 94, .2); }
    }
    .threat-high { animation: pulse-red 2s infinite; }
    .soar-active { animation: pulse-green 2s infinite; }
    .cyber-grid {
      background-image: linear-gradient(rgba(168, 85, 247, .08) 1px, transparent 1px), 
                        linear-gradient(90deg, rgba(168, 85, 247, .08) 1px, transparent 1px);
      background-size: 50px 50px;
    }
  </style>
</head>
<body class="bg-gray-900 text-white cyber-grid">
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useState, useRef, useMemo } = React;
    const API_BASE = 'http://localhost:9000';
    const WS_URL = 'ws://localhost:9000/ws';

    const Header = ({ connected, threatsCount, actionsCount, activeTab, setActiveTab }) => (
      <header className="bg-gray-800 border-b border-purple-500 px-6 py-4">
        <div className="container mx-auto">
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center space-x-4">
              <i className="fas fa-robot text-purple-500 text-2xl"></i>
              <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-400 to-blue-500 bg-clip-text text-transparent">
                SOAR Command Center
              </h1>
            </div>
            <div className="flex items-center space-x-6">
              <div className="flex items-center space-x-2">
                <div className={`w-3 h-3 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                <span className="text-sm">{connected ? 'Connected' : 'Disconnected'}</span>
              </div>
              <div className="text-sm">
                <span className="text-gray-400">Threats:</span>
                <span className="ml-2 font-bold text-blue-400">{threatsCount}</span>
              </div>
              <div className="text-sm">
                <span className="text-gray-400">Actions:</span>
                <span className="ml-2 font-bold text-green-400">{actionsCount}</span>
              </div>
            </div>
          </div>
          
          <div className="flex space-x-1">
            <button
              onClick={() => setActiveTab('threats')}
              className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${
                activeTab === 'threats' 
                  ? 'bg-gray-700 text-white border-t-2 border-purple-500' 
                  : 'bg-gray-900 text-gray-400 hover:text-white hover:bg-gray-800'
              }`}
            >
              <i className="fas fa-shield-virus mr-2"></i>
              Threat Response
            </button>
            <button
              onClick={() => setActiveTab('sandbox')}
              className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${
                activeTab === 'sandbox' 
                  ? 'bg-gray-700 text-white border-t-2 border-purple-500' 
                  : 'bg-gray-900 text-gray-400 hover:text-white hover:bg-gray-800'
              }`}
            >
              <i className="fas fa-vial mr-2"></i>
              Sandbox Analysis
            </button>
          </div>
        </div>
      </header>
    );

    const SandboxUpload = () => {
      const [file, setFile] = useState(null);
      const [analyzing, setAnalyzing] = useState(false);
      const [result, setResult] = useState(null);

      const handleFileUpload = async () => {
        if (!file) {
          alert('Please select a file first');
          return;
        }

        setAnalyzing(true);
        const formData = new FormData();
        formData.append('file', file);

        try {
          const response = await fetch('http://localhost:8001/analyze', {
            method: 'POST',
            body: formData
          });
          const analysisResult = await response.json();
          setResult(analysisResult);
        } catch (error) {
          console.error('Analysis failed:', error);
          alert('File analysis failed');
        } finally {
          setAnalyzing(false);
        }
      };

      const getVerdictColor = (verdict) => {
        switch(verdict) {
          case 'MALICIOUS': return 'text-red-400';
          case 'SUSPICIOUS': return 'text-yellow-400';
          default: return 'text-green-400';
        }
      };

      return (
        <div className="space-y-6">
          <div className="bg-gray-800 rounded-lg p-6">
            <h2 className="text-xl font-semibold mb-4">
              <i className="fas fa-upload mr-2"></i>
              Upload Suspicious File
            </h2>
            <div className="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center">
              <input 
                type="file" 
                onChange={(e) => setFile(e.target.files[0])}
                className="hidden" 
                id="fileInput" 
              />
              <label htmlFor="fileInput" className="cursor-pointer">
                <i className="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-4"></i>
                <p className="text-lg">Click to upload or drag and drop</p>
                <p className="text-sm text-gray-400">Supports EXE, DLL, PDF, DOC, etc.</p>
                {file && (
                  <p className="mt-2 text-sm text-blue-400">
                    Selected: {file.name}
                  </p>
                )}
              </label>
            </div>
            <button 
              onClick={handleFileUpload}
              disabled={!file || analyzing}
              className="mt-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 px-6 py-2 rounded-lg transition-colors"
            >
              <i className="fas fa-play mr-2"></i>
              {analyzing ? 'Analyzing...' : 'Analyze File'}
            </button>
          </div>

          {result && (
            <div className="space-y-6">
              <div className="bg-gray-800 rounded-lg p-6">
                <h3 className="text-xl font-semibold mb-4">
                  <i className="fas fa-search mr-2"></i>
                  Static Analysis
                </h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <span className="text-gray-400">File Type:</span>
                    <span className="ml-2">{result.static_analysis.file_info.file_type}</span>
                  </div>
                  <div>
                    <span className="text-gray-400">File Size:</span>
                    <span className="ml-2">{result.static_analysis.file_info.file_size} bytes</span>
                  </div>
                  <div>
                    <span className="text-gray-400">Entropy:</span>
                    <span className={`ml-2 ${result.static_analysis.entropy > 7.5 ? 'text-red-400' : 'text-green-400'}`}>
                      {result.static_analysis.entropy.toFixed(2)}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-400">Packed:</span>
                    <span className={`ml-2 ${result.static_analysis.packed ? 'text-red-400' : 'text-green-400'}`}>
                      {result.static_analysis.packed ? 'YES' : 'NO'}
                    </span>
                  </div>
                </div>
                <div className="mt-4">
                  <span className="text-gray-400">Suspicious Strings:</span>
                  <div className="mt-2 flex flex-wrap gap-2">
                    {result.static_analysis.suspicious_strings.map((s, i) => (
                      <span key={i} className="bg-red-600 px-2 py-1 rounded text-sm">
                        {s}
                      </span>
                    ))}
                  </div>
                </div>
              </div>

              <div className="bg-gray-800 rounded-lg p-6">
                <h3 className="text-xl font-semibold mb-4">
                  <i className="fas fa-vial mr-2"></i>
                  Sandbox Analysis
                </h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <span className="text-gray-400">Process Created:</span>
                    <span className={`ml-2 ${result.sandbox_analysis.process_created ? 'text-red-400' : 'text-green-400'}`}>
                      {result.sandbox_analysis.process_created ? 'YES' : 'NO'}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-400">Registry Modified:</span>
                    <span className={`ml-2 ${result.sandbox_analysis.registry_modified ? 'text-red-400' : 'text-green-400'}`}>
                      {result.sandbox_analysis.registry_modified ? 'YES' : 'NO'}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-400">Network Connection:</span>
                    <span className={`ml-2 ${result.sandbox_analysis.network_connection ? 'text-red-400' : 'text-green-400'}`}>
                      {result.sandbox_analysis.network_connection ? 'YES' : 'NO'}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-400">C2 Attempt:</span>
                    <span className={`ml-2 ${result.sandbox_analysis.c2_attempt ? 'text-red-400' : 'text-green-400'}`}>
                      {result.sandbox_analysis.c2_attempt ? 'YES' : 'NO'}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-400">File Dropped:</span>
                    <span className={`ml-2 ${result.sandbox_analysis.file_dropped ? 'text-red-400' : 'text-green-400'}`}>
                      {result.sandbox_analysis.file_dropped ? 'YES' : 'NO'}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-400">Suspicious API Calls:</span>
                    <span className={`ml-2 ${result.sandbox_analysis.suspicious_api_calls ? 'text-red-400' : 'text-green-400'}`}>
                      {result.sandbox_analysis.suspicious_api_calls ? 'YES' : 'NO'}
                    </span>
                  </div>
                </div>
              </div>

              <div className="bg-gray-800 rounded-lg p-6">
                <h3 className="text-xl font-semibold mb-4 text-center">
                  <i className="fas fa-file-alt mr-2"></i>
                  Analysis Report
                </h3>
                <div className="text-center">
                  <div className="mb-6">
                    <span className="text-gray-400">Final Risk Score:</span>
                    <span className={`text-3xl font-bold ml-2 ${getVerdictColor(result.sandbox_analysis.verdict)}`}>
                      {result.sandbox_analysis.risk_score}/100
                    </span>
                  </div>
                  <div className="mb-6">
                    <span className="text-gray-400">Verdict:</span>
                    <span className={`text-2xl font-bold ml-2 ${getVerdictColor(result.sandbox_analysis.verdict)}`}>
                      {result.sandbox_analysis.verdict}
                    </span>
                  </div>
                  <div className="mb-6">
                    <span className="text-gray-400">Action Taken:</span>
                    <span className="text-xl font-bold ml-2 text-blue-400">
                      {result.sandbox_analysis.action}
                    </span>
                  </div>
                  <div className="mt-8">
                    <span className="text-gray-400">SHA256:</span>
                    <span className="text-sm ml-2 font-mono">{result.static_analysis.sha256}</span>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const ThreatCard = ({ threat, onAction, isProcessing }) => {
      const [expanded, setExpanded] = useState(false);
      const severityColors = {
        critical: 'border-red-500 threat-high',
        high: 'border-orange-500',
        medium: 'border-yellow-500',
        low: 'border-blue-500'
      };

      const actionButtons = [
        { id: 'block', label: 'Block IP', icon: 'ban', color: 'red' },
        { id: 'rate_limit', label: 'Rate Limit', icon: 'tachometer-alt', color: 'orange' },
        { id: 'isolate', label: 'Isolate Host', icon: 'cube', color: 'purple' },
        { id: 'monitor', label: 'Monitor', icon: 'eye', color: 'blue' }
      ];

      return (
        <div className={`bg-gray-800 border rounded-lg p-4 ${severityColors[threat.severity] || 'border-gray-700'} ${isProcessing ? 'opacity-50' : ''}`}>
          <div className="flex justify-between items-start mb-3">
            <div className="flex items-center space-x-3">
              <span className={`px-2 py-1 rounded text-xs font-semibold ${
                threat.severity === 'critical' ? 'bg-red-600' :
                threat.severity === 'high' ? 'bg-orange-600' :
                threat.severity === 'medium' ? 'bg-yellow-600' :
                'bg-blue-600'
              }`}>
                {threat.severity?.toUpperCase()}
              </span>
              <span className="text-sm text-gray-400">{new Date(threat.timestamp).toLocaleTimeString()}</span>
              {threat.automatic && (
                <span className="px-2 py-1 bg-green-600 rounded text-xs">
                  <i className="fas fa-robot mr-1"></i>Auto
                </span>
              )}
            </div>
            <button 
              onClick={() => setExpanded(!expanded)}
              className="text-gray-400 hover:text-white"
            >
              <i className={`fas fa-chevron-${expanded ? 'up' : 'down'}`}></i>
            </button>
          </div>

          <div className="space-y-2">
            <div className="flex justify-between">
              <span className="text-gray-400">Attack Type:</span>
              <span className="font-semibold">{threat.attack_type}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-400">Source IP:</span>
              <span className="font-mono">{threat.source_ip}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-400">Confidence:</span>
              <span>{Math.round((threat.confidence || 0) * 100)}%</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-400">Status:</span>
              <span className={threat.blocked ? 'text-red-400' : 'text-green-400'}>
                {threat.blocked ? 'Blocked' : 'Active'}
              </span>
            </div>
          </div>

          {expanded && (
            <div className="mt-3 pt-3 border-t border-gray-700">
              <div className="text-sm text-gray-300 mb-3">
                <div className="font-semibold mb-1">Reasons:</div>
                <div>{threat.reason?.join(', ') || 'No reasons provided'}</div>
              </div>
              <div className="grid grid-cols-2 gap-2">
                {actionButtons.map(action => (
                  <button
                    key={action.id}
                    onClick={() => onAction(threat, action.id)}
                    disabled={isProcessing}
                    className={`bg-${action.color}-600 hover:bg-${action.color}-700 disabled:opacity-50 px-3 py-2 rounded text-sm flex items-center justify-center space-x-2 transition-colors`}
                  >
                    <i className={`fas fa-${action.icon}`}></i>
                    <span>{action.label}</span>
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    const ActionTimeline = ({ actions }) => {
      const timelineRef = useRef(null);
      const sortedActions = useMemo(() => 
        [...actions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)), 
        [actions]
      );

      return (
        <div className="space-y-3">
          <h3 className="text-lg font-semibold text-gray-300 mb-4">
            <i className="fas fa-history mr-2"></i>
            Action Timeline ({actions.length})
          </h3>
          {sortedActions.length === 0 ? (
            <div className="text-center py-8 text-gray-400">
              <i className="fas fa-clock text-4xl mb-2"></i>
              <p>No automated actions yet</p>
            </div>
          ) : (
            sortedActions.map((action, idx) => (
              <div key={action.id} className="bg-gray-800 rounded-lg p-4 border-l-4 border-purple-500">
                <div className="flex justify-between items-start mb-2">
                  <div className="flex items-center space-x-3">
                    <span className={`px-2 py-1 rounded text-xs font-semibold ${
                      action.action === 'BLOCK' ? 'bg-red-600' :
                      action.action === 'RATE_LIMIT' ? 'bg-orange-600' :
                      action.action === 'ISOLATE' ? 'bg-purple-600' :
                      'bg-blue-600'
                    }`}>
                      {action.action}
                    </span>
                    {action.automatic && (
                      <span className="px-2 py-1 bg-green-600 rounded text-xs">
                        <i className="fas fa-robot mr-1"></i>Auto
                      </span>
                    )}
                    {action.manual && (
                      <span className="px-2 py-1 bg-blue-600 rounded text-xs">
                        <i className="fas fa-user mr-1"></i>Manual
                      </span>
                    )}
                  </div>
                  <span className="text-sm text-gray-400">
                    {new Date(action.timestamp).toLocaleTimeString()}
                  </span>
                </div>
                
                <div className="space-y-1 text-sm">
                  {action.processingTime && (
                    <div className="text-gray-400">
                      Processing time: {action.processingTime.toFixed(0)}ms
                    </div>
                  )}
                  <div>
                    <span className="text-gray-400">Target:</span>
                    <span className="ml-2 font-mono">{action.target}</span>
                  </div>
                  <div>
                    <span className="text-gray-400">Reason:</span>
                    <span className="ml-2">{action.reason}</span>
                  </div>
                  <div>
                    <span className="text-gray-400">Confidence:</span>
                    <span className="ml-2">{Math.round((action.confidence || 0) * 100)}%</span>
                  </div>
                  {action.attackType && (
                    <div>
                      <span className="text-gray-400">Attack Type:</span>
                      <span className="ml-2">{action.attackType}</span>
                    </div>
                  )}
                </div>
              </div>
            ))
          )}
        </div>
      );
    };

    const MetricsPanel = ({ threats, actions }) => {
      const [chartData, setChartData] = useState({ labels: [], block: [], rateLimit: [], isolate: [] });
      const chartRef = useRef(null);

      useEffect(() => {
        const now = new Date();
        const labels = [];
        const block = [];
        const rateLimit = [];
        const isolate = [];

        for (let i = 23; i >= 0; i--) {
          const time = new Date(now - i * 60 * 60 * 1000);
          labels.push(time.getHours() + ':00');
          const hourActions = actions.filter(a => 
            new Date(a.timestamp).getHours() === time.getHours()
          );
          block.push(hourActions.filter(a => a.action === 'BLOCK').length);
          rateLimit.push(hourActions.filter(a => a.action === 'RATE_LIMIT').length);
          isolate.push(hourActions.filter(a => a.action === 'ISOLATE').length);
        }

        setChartData({ labels, block, rateLimit, isolate });
      }, [actions]);

      useEffect(() => {
        if (chartRef.current && chartData.labels.length > 0) {
          const ctx = chartRef.current.getContext('2d');
          if (chartRef.current._chart) {
            chartRef.current._chart.destroy();
          }
          chartRef.current._chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: chartData.labels,
              datasets: [
                {
                  label: 'Block Actions',
                  data: chartData.block,
                  borderColor: '#ef4444',
                  backgroundColor: 'rgba(239, 68, 68, 0.1)',
                  tension: 0.4
                },
                {
                  label: 'Rate Limit Actions',
                  data: chartData.rateLimit,
                  borderColor: '#f59e0b',
                  backgroundColor: 'rgba(245, 158, 11, 0.1)',
                  tension: 0.4
                },
                {
                  label: 'Isolate Actions',
                  data: chartData.isolate,
                  borderColor: '#8b5cf6',
                  backgroundColor: 'rgba(139, 92, 246, 0.1)',
                  tension: 0.4
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  labels: { color: '#e5e7eb' }
                }
              },
              scales: {
                x: {
                  ticks: { color: '#9ca3af' },
                  grid: { color: 'rgba(156, 163, 175, 0.1)' }
                },
                y: {
                  ticks: { color: '#9ca3af' },
                  grid: { color: 'rgba(156, 163, 175, 0.1)' }
                }
              }
            }
          });
        }
      }, [chartData]);

      const stats = useMemo(() => {
        const recentThreats = threats.filter(t => 
          new Date(t.timestamp) > new Date() - 60 * 60 * 1000
        );
        const recentActions = actions.filter(a => 
          new Date(a.timestamp) > new Date() - 60 * 60 * 1000
        );

        return {
          totalThreats: threats.length,
          recentThreats: recentThreats.length,
          totalActions: actions.length,
          recentActions: recentActions.length,
          blocked: actions.filter(a => a.action === 'BLOCK').length,
          rateLimited: actions.filter(a => a.action === 'RATE_LIMIT').length,
          isolated: actions.filter(a => a.action === 'ISOLATE').length,
          successRate: actions.length > 0 ? 
            (actions.filter(a => a.status === 'success').length / actions.length * 100).toFixed(1) : 0
        };
      }, [threats, actions]);

      return (
        <div className="space-y-6">
          <h3 className="text-lg font-semibold text-gray-300">
            <i className="fas fa-chart-line mr-2"></i>
            SOAR Metrics
          </h3>
          
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-gray-800 rounded-lg p-4 text-center">
              <div className="text-2xl font-bold text-blue-400">{stats.totalThreats}</div>
              <div className="text-sm text-gray-400">Total Threats</div>
            </div>
            <div className="bg-gray-800 rounded-lg p-4 text-center">
              <div className="text-2xl font-bold text-green-400">{stats.totalActions}</div>
              <div className="text-sm text-gray-400">Total Actions</div>
            </div>
            <div className="bg-gray-800 rounded-lg p-4 text-center">
              <div className="text-2xl font-bold text-red-400">{stats.blocked}</div>
              <div className="text-sm text-gray-400">Blocked IPs</div>
            </div>
            <div className="bg-gray-800 rounded-lg p-4 text-center">
              <div className="text-2xl font-bold text-purple-400">{stats.successRate}%</div>
              <div className="text-sm text-gray-400">Success Rate</div>
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-6">
            <h4 className="text-md font-semibold mb-4">24-Hour Action Trends</h4>
            <div className="h-64">
              <canvas ref={chartRef}></canvas>
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const [connected, setConnected] = useState(false);
      const [threats, setThreats] = useState([]);
      const [actions, setActions] = useState([]);
      const [processingThreats, setProcessingThreats] = useState(new Set());
      const [activeTab, setActiveTab] = useState('threats');

      useEffect(() => {
        const ws = new WebSocket(WS_URL);
        
        ws.onopen = () => {
          setConnected(true);
          console.log('ðŸ”Œ Connected to WebSocket');
        };
        
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          
          if (data.type === 'new_threat' && data.data) {
            const threat = Array.isArray(data.data) ? data.data[0] : data.data;
            
            if (threat.label === 'malicious' || threat.confidence >= 0.70) {
              setThreats(prev => [threat, ...prev].slice(0, 50));
              
              const action = {
                id: Date.now() + Math.random(),
                timestamp: new Date().toISOString(),
                flowId: threat.flow_id,
                attackType: threat.attack_type,
                confidence: threat.confidence,
                action: threat.confidence >= 0.85 ? 'BLOCK' : 'RATE_LIMIT',
                severity: threat.confidence >= 0.85 ? 'critical' : 'high',
                automatic: true,
                processingTime: Math.floor(Math.random() * 3000) + 2000,
                target: threat.source_ip,
                status: 'success',
                details: {
                  reason: `Confidence: ${(threat.confidence * 100).toFixed(1)}%`,
                  trigger: threat.confidence >= 0.85 ? 'High confidence' : 'Pattern detected'
                }
              };
              
              setActions(prev => [action, ...prev].slice(0, 100));
            }
          }
        };
        
        ws.onclose = () => {
          setConnected(false);
          console.log('âŒ Disconnected from WebSocket');
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          setConnected(false);
        };
        
        return () => ws.close();
      }, []);

      const handleAction = async (threat, actionType) => {
        setProcessingThreats(prev => new Set(prev).add(threat.flow_id));
        
        try {
          await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
          
          const action = {
            id: Date.now() + Math.random(),
            action: actionType.toUpperCase(),
            target: threat.source_ip,
            reason: `Manual ${actionType} action by operator`,
            confidence: threat.confidence,
            timestamp: new Date().toISOString(),
            status: 'success',
            threatId: threat.flow_id,
            attackType: threat.attack_type,
            severity: threat.severity,
            manual: true,
            processingTime: 500 + Math.random() * 1000
          };
          
          setActions(prev => [action, ...prev].slice(0, 200));
          
          if (actionType === 'block') {
            setThreats(prev => prev.map(t => 
              t.flow_id === threat.flow_id ? { ...t, blocked: true } : t
            ));
          }
          
          console.log(`ðŸ‘¤ Manual SOAR Action: ${actionType} on ${threat.source_ip}`);
        } catch (error) {
          console.error('âŒ Error executing manual action:', error);
        } finally {
          setProcessingThreats(prev => {
            const newSet = new Set(prev);
            newSet.delete(threat.flow_id);
            return newSet;
          });
        }
      };

      const activeThreats = threats.filter(t => !t.blocked);
      const recentThreats = activeThreats.slice(0, 10);

      return (
        <div className="min-h-screen">
          <Header 
            connected={connected} 
            threatsCount={threats.length} 
            actionsCount={actions.length}
            activeTab={activeTab}
            setActiveTab={setActiveTab}
          />
          
          <main className="container mx-auto p-6">
            {activeTab === 'threats' ? (
              <div className="space-y-6">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <h2 className="text-xl font-semibold text-gray-300">
                      <i className="fas fa-exclamation-triangle mr-2"></i>
                      Active Threats ({activeThreats.length})
                    </h2>
                    <div className="space-y-3">
                      {recentThreats.length === 0 ? (
                        <div className="text-center py-8 text-gray-400">
                          <i className="fas fa-shield-alt text-4xl mb-2"></i>
                          <p>No active threats detected</p>
                        </div>
                      ) : (
                        recentThreats.map(threat => (
                          <ThreatCard 
                            key={threat.flow_id}
                            threat={threat}
                            onAction={handleAction}
                            isProcessing={processingThreats.has(threat.flow_id)}
                          />
                        ))
                      )}
                    </div>
                  </div>

                  <div className="space-y-4">
                    <ActionTimeline actions={actions} />
                  </div>
                </div>

                <MetricsPanel threats={threats} actions={actions} />
              </div>
            ) : (
              <SandboxUpload />
            )}
          </main>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
