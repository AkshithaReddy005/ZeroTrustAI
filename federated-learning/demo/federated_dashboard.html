<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Federated Learning â€” ZTAI Platform</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=IBM+Plex+Mono:wght@400;600&family=Lato:wght@300;400;700&display=swap');

:root {
  --bg: #040b14;
  --surface: #0a1628;
  --card: #0f1f35;
  --border: #1a2f4a;
  --blue: #00a8ff;
  --green: #00e676;
  --red: #ff4444;
  --orange: #ff9100;
  --yellow: #ffd740;
  --purple: #b388ff;
  --teal: #00e5ff;
  --text: #e8f4fd;
  --dim: #7a9ab8;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed; inset: 0;
  background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(0,168,255,0.06) 0%, transparent 60%);
  pointer-events: none;
}

/* HEADER */
header {
  text-align: center;
  padding: 40px 20px 30px;
  position: relative;
}
.header-tag {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 11px;
  letter-spacing: 4px;
  color: var(--blue);
  text-transform: uppercase;
  border: 1px solid rgba(0,168,255,.3);
  background: rgba(0,168,255,.06);
  padding: 5px 16px;
  border-radius: 20px;
  display: inline-block;
  margin-bottom: 16px;
}
header h1 {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  font-size: clamp(28px, 5vw, 52px);
  font-weight: 800;
  background: linear-gradient(135deg, #00a8ff 0%, #00e5ff 50%, #00e676 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 10px;
}
header p { color: var(--dim); font-size: 16px; max-width: 600px; margin: 0 auto; }

/* TABS */
.tabs {
  display: flex;
  justify-content: center;
  gap: 8px;
  padding: 20px;
  flex-wrap: wrap;
}
.tab {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 1px;
  padding: 10px 24px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--dim);
  cursor: pointer;
  transition: all .2s;
  text-transform: uppercase;
}
.tab.active { border-color: var(--blue); color: var(--blue); background: rgba(0,168,255,.1); }
.tab:hover:not(.active) { border-color: rgba(255,255,255,.2); color: var(--text); }

.panel { display: none; padding: 0 24px 60px; max-width: 1400px; margin: 0 auto; }
.panel.active { display: block; }

/* SECTION TITLE */
.sec-title {
  font-family: 'Syne', sans-serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 6px;
}
.sec-sub { color: var(--dim); font-size: 14px; margin-bottom: 28px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL 1 â€” PIPELINE ANIMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pipeline-wrap {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 36px 28px;
  margin-bottom: 24px;
}

/* Round controls */
.round-ctrl {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  margin-bottom: 36px;
  flex-wrap: wrap;
}
.round-btn {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 1px;
  padding: 10px 20px;
  border-radius: 8px;
  border: 1px solid var(--blue);
  background: rgba(0,168,255,.1);
  color: var(--blue);
  cursor: pointer;
  transition: all .2s;
  text-transform: uppercase;
}
.round-btn:hover { background: rgba(0,168,255,.2); }
.round-btn.play { background: var(--blue); color: #000; font-weight: 700; }
.round-btn.play:hover { background: #33b8ff; }
.round-info {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 14px;
  color: var(--text);
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 8px 20px;
  border-radius: 8px;
  min-width: 140px;
  text-align: center;
}

/* Pipeline diagram */
.pipeline-diagram {
  position: relative;
  display: grid;
  grid-template-columns: 1fr 80px 1fr 80px 1fr;
  gap: 0;
  align-items: center;
  margin-bottom: 32px;
}

/* Client column */
.clients-col { display: flex; flex-direction: column; gap: 12px; }

.org-card {
  border-radius: 12px;
  border: 2px solid;
  padding: 14px 16px;
  transition: all .3s;
  position: relative;
  overflow: hidden;
}
.org-card::before {
  content: '';
  position: absolute;
  inset: 0;
  opacity: 0;
  transition: opacity .3s;
}
.org-card.bank   { border-color: var(--blue);   background: rgba(0,168,255,.05); }
.org-card.hosp   { border-color: var(--green);  background: rgba(0,230,118,.05); }
.org-card.tech   { border-color: var(--purple); background: rgba(179,136,255,.05); }
.org-card.evil   { border-color: var(--red);    background: rgba(255,68,68,.05); }

.org-card.bank::before   { background: rgba(0,168,255,.08); }
.org-card.hosp::before   { background: rgba(0,230,118,.08); }
.org-card.tech::before   { background: rgba(179,136,255,.08); }
.org-card.evil::before   { background: rgba(255,68,68,.08); }

.org-card.sending::before, .org-card.receiving::before { opacity: 1; }
.org-card.sending { transform: translateX(4px); }
.org-card.receiving { transform: translateX(-4px); }

.org-icon { font-size: 22px; margin-bottom: 4px; }
.org-name {
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  font-weight: 700;
}
.org-data { font-size: 11px; color: var(--dim); margin-top: 2px; font-family: 'IBM Plex Mono', monospace; }
.org-data { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
.org-status {
  font-size: 10px;
  font-family: 'IBM Plex Mono', monospace;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 10px;
  display: inline-block;
  margin-top: 6px;
  opacity: 0;
  transition: opacity .3s;
}
.org-card.sending .org-status { opacity: 1; background: rgba(0,168,255,.2); color: var(--blue); }
.org-card.receiving .org-status { opacity: 1; background: rgba(0,230,118,.2); color: var(--green); }
.org-card.evil.blocked .org-status { opacity: 1; background: rgba(255,68,68,.2); color: var(--red); }

/* Arrow col */
.arrow-col {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 0 8px;
}
.arrow-svg { width: 60px; overflow: visible; }
.arrow-path {
  stroke-dasharray: 8 4;
  stroke-dashoffset: 0;
  animation: none;
}
.arrow-path.flowing {
  animation: flow 1s linear infinite;
}
@keyframes flow {
  to { stroke-dashoffset: -24; }
}
.arrow-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  color: var(--dim);
  text-align: center;
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* Server */
.server-col {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.server-card {
  border-radius: 16px;
  border: 2px solid var(--teal);
  background: rgba(0,229,255,.06);
  padding: 20px;
  text-align: center;
  transition: all .3s;
  width: 100%;
  max-width: 200px;
}
.server-card.aggregating {
  border-color: var(--yellow);
  background: rgba(255,215,64,.08);
  box-shadow: 0 0 30px rgba(255,215,64,.2);
}
.server-icon { font-size: 32px; margin-bottom: 8px; }
.server-name {
  font-family: 'Syne', sans-serif;
  font-size: 14px;
  font-weight: 700;
  color: var(--teal);
  margin-bottom: 4px;
}
.server-status {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 10px;
  color: var(--dim);
  min-height: 16px;
}
.server-badge {
  display: inline-block;
  margin-top: 8px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 9px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 10px;
  background: rgba(0,229,255,.15);
  color: var(--teal);
  letter-spacing: 1px;
}
.server-badge.warning { background: rgba(255,68,68,.15); color: var(--red); }

/* Step description */
.step-desc {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px 24px;
  margin-top: 8px;
}
.step-title {
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 8px;
}
.step-body { font-size: 14px; color: var(--dim); line-height: 1.7; }
.step-body strong { color: var(--text); }

/* Progress dots */
.step-dots {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px;
}
.dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--border);
  transition: all .3s;
  cursor: pointer;
}
.dot.active { background: var(--blue); box-shadow: 0 0 8px var(--blue); }
.dot.done { background: var(--green); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL 2 â€” RESULTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}
.metric-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px 22px;
  position: relative;
  overflow: hidden;
}
.metric-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  border-radius: 14px 14px 0 0;
}
.metric-card.blue::after  { background: var(--blue); }
.metric-card.green::after { background: var(--green); }
.metric-card.red::after   { background: var(--red); }
.metric-card.teal::after  { background: var(--teal); }
.metric-card.purple::after { background: var(--purple); }

.metric-label { font-size: 12px; color: var(--dim); font-family: 'IBM Plex Mono', monospace; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; }
.metric-label { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
.metric-val { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; font-size: 36px; font-weight: 800; font-variant-numeric: tabular-nums; }
.metric-sub { font-size: 12px; color: var(--dim); margin-top: 4px; }
.metric-delta { font-size: 13px; font-weight: 700; margin-top: 6px; }
.metric-delta.up { color: var(--green); }
.metric-delta.down { color: var(--red); }

/* Rounds table */
.rounds-table {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
  margin-bottom: 24px;
}
.rounds-table table { width: 100%; border-collapse: collapse; }
.rounds-table th {
  background: var(--surface);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--dim);
  padding: 14px 18px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
.rounds-table td {
  padding: 13px 18px;
  font-size: 14px;
  border-bottom: 1px solid rgba(255,255,255,.04);
}
.rounds-table tr:last-child td { border-bottom: none; }
.rounds-table tr:hover td { background: rgba(255,255,255,.02); }
.f1-bar {
  display: flex;
  align-items: center;
  gap: 10px;
}
.f1-track {
  flex: 1;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.f1-fill {
  height: 100%;
  border-radius: 3px;
  transition: width .5s ease;
}
.round-badge {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 10px;
  border-radius: 6px;
  background: rgba(0,168,255,.15);
  color: var(--blue);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL 3 â€” BYZANTINE DEFENSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.byzantine-hero {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 36px;
  margin-bottom: 24px;
  text-align: center;
}
.versus {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 24px;
  align-items: center;
  margin-top: 28px;
}
.vs-card {
  border-radius: 14px;
  padding: 24px;
  border: 2px solid;
}
.vs-card.danger { border-color: var(--red); background: rgba(255,68,68,.05); }
.vs-card.safe   { border-color: var(--green); background: rgba(0,230,118,.05); }
.vs-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 12px;
}
.vs-label.danger { color: var(--red); }
.vs-label.safe   { color: var(--green); }
.vs-title {
  font-family: 'Syne', sans-serif;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 8px;
}
.vs-desc { font-size: 13px; color: var(--dim); line-height: 1.6; }
.vs-score {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  font-size: 42px;
  font-weight: 800;
  margin-top: 16px;
  font-variant-numeric: tabular-nums;
}
.vs-sub { font-size: 12px; color: var(--dim); font-family: 'IBM Plex Mono', monospace; }
.vs-separator {
  font-family: 'Syne', sans-serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--dim);
}

.poison-viz {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 28px;
}
.poison-title {
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 20px;
}

.weight-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}
.weight-card {
  border-radius: 10px;
  border: 1.5px solid;
  padding: 14px;
  text-align: center;
}
.weight-card.normal { border-color: rgba(0,168,255,.4); background: rgba(0,168,255,.06); }
.weight-card.poison { border-color: rgba(255,68,68,.4); background: rgba(255,68,68,.06); }
.weight-icon { font-size: 20px; margin-bottom: 6px; }
.weight-name { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
.weight-val { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--dim); }
.weight-val.poison-val { color: var(--red); }

.median-explain {
  background: var(--surface);
  border: 1px solid rgba(0,229,255,.3);
  border-radius: 10px;
  padding: 16px 20px;
  font-size: 13px;
  color: var(--dim);
  line-height: 1.7;
}
.median-explain strong { color: var(--teal); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-wrap {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 28px;
  margin-bottom: 24px;
}
.chart-title {
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 24px;
}
.chart-area {
  position: relative;
  height: 220px;
}
.chart-svg { width: 100%; height: 100%; overflow: visible; }
.chart-legend {
  display: flex;
  gap: 20px;
  margin-top: 16px;
  flex-wrap: wrap;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--dim);
}
.legend-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* Jury message */
.jury-msg {
  background: linear-gradient(135deg, rgba(0,168,255,.08), rgba(0,229,255,.05));
  border: 1px solid rgba(0,168,255,.3);
  border-radius: 16px;
  padding: 28px 32px;
  margin-top: 24px;
}
.jury-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  letter-spacing: 3px;
  color: var(--blue);
  text-transform: uppercase;
  margin-bottom: 10px;
}
.jury-text {
  font-size: 16px;
  line-height: 1.8;
  color: var(--text);
  font-style: italic;
}

/* Responsive */
@media (max-width: 768px) {
  .pipeline-diagram { grid-template-columns: 1fr; }
  .arrow-col { transform: rotate(90deg); }
  .versus { grid-template-columns: 1fr; }
  .vs-separator { display: none; }
  .weight-grid { grid-template-columns: repeat(2, 1fr); }
 }

 /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    MINIMAL DEMO MODE (keep only what is required)
    - preserves element IDs for live polling
    - hides extra storytelling blocks that clutter the UI
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
 body.minimal .jury-msg { display: none !important; }
 body.minimal .rounds-table { display: none !important; }
 body.minimal .poison-viz { display: none !important; }
 body.minimal .vs-desc,
 body.minimal .vs-sub { display: none !important; }
 body.minimal #liveHint { display: none !important; }
 body.minimal header { padding: 28px 20px 14px; }
 body.minimal header p { display: none; }
 body.minimal header p#liveStatus { display: block; }
 body.minimal .sec-sub { display: none !important; }
 body.minimal .chart-legend { display: none !important; }
</style>
</head>
<body class="minimal">

<div id="liveBadge" style="position:fixed;top:14px;right:14px;z-index:9999;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:rgba(10,22,40,0.85);backdrop-filter: blur(8px);font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim);max-width:520px;">Live: initializingâ€¦</div>

<header>
  <div class="header-tag">ğŸ” Zero Trust AI Platform</div>
  <h1>Federated Learning System</h1>
  <p>Cross-domain threat intelligence sharing without exposing private data â€” visualized end to end</p>
  <p id="liveHint" style="margin-top:10px;color:var(--dim);font-size:12px;font-family:'IBM Plex Mono',monospace;">Live mode: run via local HTTP server (not file://) to auto-load CSV results.</p>
  <p id="liveStatus" style="margin-top:8px;color:var(--dim);font-size:12px;font-family:'IBM Plex Mono',monospace;">Live status: not started</p>
</header>

<div class="tabs">
  <div class="tab active" onclick="switchTab('pipeline')">â‘  Pipeline Animation</div>
  <div class="tab" onclick="switchTab('results')">â‘¡ Learning Results</div>
  <div class="tab" onclick="switchTab('byzantine')">â‘¢ Byzantine Defense</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PANEL 1 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel active" id="panel-pipeline">
  <div class="pipeline-wrap">
    <div class="sec-title">End-to-End Federated Learning Pipeline</div>
    <div class="sec-sub">Watch exactly what happens in each round â€” step by step, from local training to global model update</div>

    <div class="step-dots" id="stepDots"></div>

    <div class="round-ctrl">
      <button class="round-btn" onclick="prevStep()">â† Prev Step</button>
      <div class="round-info" id="roundInfo">Round 0 Â· Step 1/5</div>
      <div class="round-info" style="padding:0;border:none;background:transparent;min-width:auto;">
        <select id="pipelineMethod" onchange="setPipelineMethod(this.value)" style="background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;">
          <option value="fedavg">FedAvg</option>
          <option value="fedmedian">FedMedian</option>
        </select>
      </div>
      <button class="round-btn play" onclick="autoPlay()" id="playBtn">â–¶ Auto Play</button>
      <button class="round-btn" onclick="nextStep()">Next Step â†’</button>
    </div>

    <div class="results-grid" style="margin-bottom:24px;">
      <div class="metric-card blue">
        <div class="metric-label">Client â€” Bank</div>
        <div class="metric-val" style="font-size:22px;" id="p_bank_client">â€”</div>
        <div class="metric-sub" id="p_bank_client_sub">loss â€” Â· f1 â€”</div>
      </div>
      <div class="metric-card green">
        <div class="metric-label">Client â€” Hospital</div>
        <div class="metric-val" style="font-size:22px;" id="p_hospital_client">â€”</div>
        <div class="metric-sub" id="p_hospital_client_sub">loss â€” Â· f1 â€”</div>
      </div>
      <div class="metric-card purple">
        <div class="metric-label">Client â€” Tech</div>
        <div class="metric-val" style="font-size:22px;" id="p_tech_client">â€”</div>
        <div class="metric-sub" id="p_tech_client_sub">loss â€” Â· f1 â€”</div>
      </div>
      <div class="metric-card red">
        <div class="metric-label">Client â€” Malicious</div>
        <div class="metric-val" style="font-size:22px;" id="p_malicious_client">â€”</div>
        <div class="metric-sub" id="p_malicious_client_sub">loss â€” Â· f1 â€”</div>
      </div>
    </div>

    <div class="results-grid" style="margin-bottom:18px;">
      <div class="metric-card teal">
        <div class="metric-label">Round Metric â€” Global â†’ Hospital</div>
        <div class="metric-val" style="color:var(--teal)" id="p_global_on_hospital">â€”</div>
        <div class="metric-sub">From <code>fedavg_hospital_moneyshot.csv</code></div>
      </div>
      <div class="metric-card blue">
        <div class="metric-label">Round Metric â€” Bank â†’ Hospital (C2)</div>
        <div class="metric-val" style="color:var(--blue)" id="p_bank_on_hospital">â€”</div>
        <div class="metric-sub">Cross-domain transfer</div>
      </div>
      <div class="metric-card purple">
        <div class="metric-label">Round Metric â€” Hospital â†’ Bank (DDoS)</div>
        <div class="metric-val" style="color:var(--purple)" id="p_hospital_on_bank">â€”</div>
        <div class="metric-sub">Cross-domain transfer</div>
      </div>
      <div class="metric-card red">
        <div class="metric-label">Byzantine (This Round) â€” FedAvg vs FedMedian</div>
        <div class="metric-val" style="color:var(--red);font-size:22px;line-height:1.2;" id="p_byzantine_pair">â€”</div>
        <div class="metric-sub">From <code>byzantine_defense_history.csv</code></div>
      </div>
    </div>

    <!-- PIPELINE DIAGRAM -->
    <div class="pipeline-diagram">

      <!-- LEFT: CLIENTS -->
      <div class="clients-col">
        <div class="org-card bank" id="org-bank">
          <div class="org-icon">ğŸ¦</div>
          <div class="org-name" style="color:var(--blue)">Bank</div>
          <div class="org-data">DDoS patterns Â· 15K flows</div>
          <div class="org-status" id="status-bank">TRAINING...</div>
        </div>
        <div class="org-card hosp" id="org-hosp">
          <div class="org-icon">ğŸ¥</div>
          <div class="org-name" style="color:var(--green)">Hospital</div>
          <div class="org-data">C2 beaconing Â· 14K flows</div>
          <div class="org-status" id="status-hosp">TRAINING...</div>
        </div>
        <div class="org-card tech" id="org-tech">
          <div class="org-icon">ğŸ–¥ï¸</div>
          <div class="org-name" style="color:var(--purple)">Tech Hub</div>
          <div class="org-data">Mixed attacks Â· 14K flows</div>
          <div class="org-status" id="status-tech">TRAINING...</div>
        </div>
        <div class="org-card evil" id="org-evil">
          <div class="org-icon">â˜ ï¸</div>
          <div class="org-name" style="color:var(--red)">Malicious Org</div>
          <div class="org-data">Inverted labels Â· poisoned</div>
          <div class="org-status" id="status-evil">BLOCKED</div>
        </div>
      </div>

      <!-- ARROW LEFT -->
      <div class="arrow-col">
        <svg class="arrow-svg" viewBox="0 0 60 160" id="arrow-left">
          <defs>
            <marker id="arrowBlue" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
              <polygon points="0 0, 6 3, 0 6" fill="var(--blue)" opacity="0.6"/>
            </marker>
            <marker id="arrowRed" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
              <polygon points="0 0, 6 3, 0 6" fill="var(--red)" opacity="0.6"/>
            </marker>
          </defs>
          <line x1="30" y1="10" x2="30" y2="150" stroke="var(--blue)" stroke-width="2"
                stroke-dasharray="8 4" class="arrow-path" id="left-flow"
                marker-end="url(#arrowBlue)" opacity="0.5"/>
          <line x1="30" y1="140" x2="30" y2="20" stroke="var(--red)" stroke-width="2"
                stroke-dasharray="6 4" class="arrow-path" id="evil-flow"
                marker-end="url(#arrowRed)" opacity="0" style="display:none"/>
        </svg>
        <div class="arrow-label" id="left-label">weights â†’</div>
      </div>

      <!-- CENTER: SERVER -->
      <div class="server-col">
        <div class="server-card" id="server-card">
          <div class="server-icon">ğŸ›¡ï¸</div>
          <div class="server-name">Federated Server</div>
          <div class="server-status" id="server-status">Waiting for weights...</div>
          <div class="server-badge" id="server-badge">FedMedian</div>
        </div>
      </div>

      <!-- ARROW RIGHT -->
      <div class="arrow-col">
        <svg class="arrow-svg" viewBox="0 0 60 160" id="arrow-right">
          <defs>
            <marker id="arrowGreen" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
              <polygon points="0 0, 6 3, 0 6" fill="var(--green)" opacity="0.7"/>
            </marker>
          </defs>
          <line x1="30" y1="10" x2="30" y2="150" stroke="var(--green)" stroke-width="2"
                stroke-dasharray="8 4" class="arrow-path" id="right-flow"
                marker-end="url(#arrowGreen)" opacity="0"/>
        </svg>
        <div class="arrow-label" id="right-label">global model â†“</div>
      </div>

      <!-- RIGHT: CLIENTS AGAIN (receiving) -->
      <div class="clients-col">
        <div class="org-card bank" id="org-bank-r">
          <div class="org-icon">ğŸ¦</div>
          <div class="org-name" style="color:var(--blue)">Bank</div>
          <div class="org-data">Now knows C2 patterns</div>
          <div class="org-status" id="status-bank-r">UPDATED</div>
        </div>
        <div class="org-card hosp" id="org-hosp-r">
          <div class="org-icon">ğŸ¥</div>
          <div class="org-name" style="color:var(--green)">Hospital</div>
          <div class="org-data">Now knows DDoS patterns</div>
          <div class="org-status" id="status-hosp-r">UPDATED</div>
        </div>
        <div class="org-card tech" id="org-tech-r">
          <div class="org-icon">ğŸ–¥ï¸</div>
          <div class="org-name" style="color:var(--purple)">Tech Hub</div>
          <div class="org-data">Now knows all patterns</div>
          <div class="org-status" id="status-tech-r">UPDATED</div>
        </div>
        <div class="org-card evil" id="org-evil-r" style="opacity:0.3">
          <div class="org-icon">â˜ ï¸</div>
          <div class="org-name" style="color:var(--red)">Malicious Org</div>
          <div class="org-data">Excluded by FedMedian</div>
          <div class="org-status" id="status-evil-r">EXCLUDED</div>
        </div>
      </div>
    </div>

    <!-- STEP DESCRIPTION -->
    <div class="step-desc">
      <div class="step-title" id="stepTitle">ğŸ”µ Step 1: Local Training</div>
      <div class="step-body" id="stepBody">Each organization trains a local model on their <strong>private data only</strong>. The Bank trains on DDoS traffic, the Hospital trains on C2 beaconing, the Tech Hub trains on mixed attacks. <strong>Raw data never leaves their premises.</strong> The malicious organization also trains â€” but with deliberately poisoned labels.</div>
    </div>
  </div>

  <div class="jury-msg">
    <div class="jury-label">ğŸ¤ Jury Talking Point</div>
    <div class="jury-text">"Every organization trains on its own private data. No raw packets, no patient records, no financial logs are ever transmitted. Only compressed model weight tensors travel over the network â€” and our FedMedian aggregator mathematically filters out poisoned weights before they can corrupt the global model."</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PANEL 2 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-results">
  <div class="sec-title">Cross-Domain Learning Results</div>
  <div class="sec-sub">How models that only knew one attack type learned to detect all attack types through federation</div>

  <div class="results-grid">
    <div class="metric-card blue">
      <div class="metric-label">Bank â†’ C2 Detection (Round 0)</div>
      <div class="metric-val" style="color:var(--red)" id="m_bank_on_hospital_r0">â€”</div>
      <div class="metric-sub">Bank never trained on C2 beaconing</div>
      <div class="metric-delta down">âŒ Blind to Hospital attacks</div>
    </div>
    <div class="metric-card green">
      <div class="metric-label">Bank â†’ C2 Detection (Round 5)</div>
      <div class="metric-val" style="color:var(--green)" id="m_bank_on_hospital_rN">â€”</div>
      <div class="metric-sub">Isolated bank model â€” limited gain</div>
      <div class="metric-delta up">âœ… Global model compensates</div>
    </div>
    <div class="metric-card teal">
      <div class="metric-label">Global Model â†’ ALL Domains</div>
      <div class="metric-val" style="color:var(--teal)" id="m_global_all_rN">â€”</div>
      <div class="metric-sub">After 5 federated rounds</div>
      <div class="metric-delta up" id="m_global_all_delta">â€”</div>
    </div>
    <div class="metric-card purple">
      <div class="metric-label">Hospital â†’ DDoS (Round 5)</div>
      <div class="metric-val" style="color:var(--purple)" id="m_hosp_on_bank_rN">â€”</div>
      <div class="metric-sub">Hospital learned DDoS from Bank</div>
      <div class="metric-delta up" id="m_hosp_on_bank_delta">â€”</div>
    </div>
  </div>

  <!-- CHART -->
  <div class="chart-wrap">
    <div class="chart-title">ğŸ“ˆ Global Model Performance Across Rounds</div>
    <div class="chart-area" id="resultsChart"></div>
    <div class="chart-legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--teal)"></div>Global Model (Fed)</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>Bank Isolated</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Hospital Isolated</div>
    </div>
  </div>

  <!-- ROUNDS TABLE -->
  <div class="rounds-table">
    <table>
      <thead>
        <tr>
          <th>Round</th>
          <th>Bank â†’ C2</th>
          <th>Hospital â†’ DDoS</th>
          <th>Global â†’ All</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="resultsRoundsBody"></tbody>
    </table>
  </div>

  <div class="jury-msg">
    <div class="jury-label">ğŸ¤ Jury Talking Point</div>
    <div class="jury-text">"The Bank model in isolation only detects C2 beaconing at 34.8% â€” it has never seen it. After 5 federated rounds, the Global model detects ALL attack types at 92.9%. The Bank learned to detect C2 from the Hospital. The Hospital learned to detect DDoS from the Bank. Zero raw data was ever shared â€” only model weight tensors."</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PANEL 3 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-byzantine">
  <div class="sec-title">Byzantine Defense â€” FedMedian vs FedAvg</div>
  <div class="sec-sub">How the 4th malicious organization fails to corrupt the global model</div>

  <div class="byzantine-hero">
    <div style="font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:3px;color:var(--red);text-transform:uppercase;margin-bottom:12px;">âš ï¸ Attack Scenario</div>
    <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:10px;">The 4th organization sends poisoned model weights</div>
    <div style="color:var(--dim);font-size:14px;max-width:600px;margin:0 auto;">Its training labels are inverted â€” it calls malicious traffic "benign" and benign traffic "malicious." If the server naively averages all weights, the global model is corrupted.</div>

    <div class="versus">
      <div class="vs-card danger">
        <div class="vs-label danger">âŒ FedAvg â€” Vulnerable</div>
        <div class="vs-title">Simple Average</div>
        <div class="vs-desc">Takes the mathematical mean of all 4 client weights. The poisoned organization's extreme values drag the average toward its corrupt distribution.</div>
        <div class="vs-score" style="color:var(--red)" id="b_fedavg_final">â€”</div>
        <div class="vs-sub">F1 after poisoning attack</div>
      </div>
      <div class="vs-separator">VS</div>
      <div class="vs-card safe">
        <div class="vs-label safe">âœ… FedMedian â€” Robust</div>
        <div class="vs-title">Coordinate-wise Median</div>
        <div class="vs-desc">Takes the statistical median of each weight coordinate across clients. The poisoned organization's extreme values are mathematical outliers â€” the median ignores them.</div>
        <div class="vs-score" style="color:var(--green)" id="b_fedmedian_final">â€”</div>
        <div class="vs-sub">F1 maintained despite attack</div>
      </div>
    </div>
  </div>

  <!-- WEIGHT VISUALIZATION -->
  <div class="poison-viz">
    <div class="poison-title">ğŸ”¬ How FedMedian Filters Poisoned Weights</div>
    <div style="color:var(--dim);font-size:13px;margin-bottom:20px;">For a single weight parameter â€” say, layer 1, neuron 3 â€” each client sends a value. Watch how the median ignores the outlier.</div>

    <div class="weight-grid">
      <div class="weight-card normal">
        <div class="weight-icon">ğŸ¦</div>
        <div class="weight-name" style="color:var(--blue)">Bank</div>
        <div class="weight-val">w = 0.42</div>
        <div style="font-size:10px;color:var(--dim);margin-top:4px;">normal range</div>
      </div>
      <div class="weight-card normal">
        <div class="weight-icon">ğŸ¥</div>
        <div class="weight-name" style="color:var(--green)">Hospital</div>
        <div class="weight-val">w = 0.38</div>
        <div style="font-size:10px;color:var(--dim);margin-top:4px;">normal range</div>
      </div>
      <div class="weight-card normal">
        <div class="weight-icon">ğŸ–¥ï¸</div>
        <div class="weight-name" style="color:var(--purple)">Tech Hub</div>
        <div class="weight-val">w = 0.45</div>
        <div style="font-size:10px;color:var(--dim);margin-top:4px;">normal range</div>
      </div>
      <div class="weight-card poison">
        <div class="weight-icon">â˜ ï¸</div>
        <div class="weight-name" style="color:var(--red)">Malicious</div>
        <div class="weight-val poison-val">w = -8.91</div>
        <div style="font-size:10px;color:var(--red);margin-top:4px;">extreme outlier</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
      <div style="background:rgba(255,68,68,.06);border:1px solid rgba(255,68,68,.3);border-radius:10px;padding:16px;">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--red);margin-bottom:8px;letter-spacing:1px;">FEDAVG (VULNERABLE)</div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--text)">mean(0.42, 0.38, 0.45, <span style="color:var(--red)">-8.91</span>)</div>
        <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:700;color:var(--red);margin-top:8px;">= -1.915</div>
        <div style="font-size:11px;color:var(--dim);margin-top:4px;">Poisoned weight corrupts global model</div>
      </div>
      <div style="background:rgba(0,230,118,.06);border:1px solid rgba(0,230,118,.3);border-radius:10px;padding:16px;">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--green);margin-bottom:8px;letter-spacing:1px;">FEDMEDIAN (ROBUST)</div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--text)">median(0.38, 0.42, 0.45, <span style="color:var(--red)">-8.91</span>)</div>
        <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:700;color:var(--green);margin-top:8px;">= 0.420</div>
        <div style="font-size:11px;color:var(--dim);margin-top:4px;">Outlier filtered â€” clean aggregation</div>
      </div>
    </div>

    <div class="median-explain">
      <strong>Why this works:</strong> The coordinate-wise median sorts all client weight values for each parameter independently and picks the middle value. An outlier like <span style="color:var(--red);font-family:'IBM Plex Mono',monospace">-8.91</span> is always at one extreme of the sorted list â€” it can never be the median unless more than half the clients are malicious. With 3 honest clients out of 4, <strong>FedMedian is mathematically guaranteed to produce a clean aggregation</strong> regardless of how extreme the poison values are.
    </div>
  </div>

  <div class="jury-msg" style="margin-top:24px;">
    <div class="jury-label">ğŸ¤ Jury Talking Point</div>
    <div class="jury-text">"We anticipated that not every organization in a federation can be trusted. Our server uses coordinate-wise median aggregation instead of simple averaging. A malicious client's extreme weight values are always statistical outliers â€” the median mathematically ignores them. FedAvg degrades to 41% F1 under this poisoning attack. FedMedian maintains 89% F1. We tested this deliberately."</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    const names = ['pipeline','results','byzantine'];
    t.classList.toggle('active', names[i] === name);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIPELINE ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STEPS = [
  {
    title: 'ğŸ”µ Step 1: Local Training',
    body: 'Each organization trains a local model on their <strong>private data only</strong>. The Bank trains on DDoS traffic, the Hospital on C2 beaconing, the Tech Hub on mixed attacks. <strong>Raw data never leaves their premises.</strong> The malicious organization also trains â€” but with deliberately poisoned (inverted) labels.',
    phase: 'train'
  },
  {
    title: 'ğŸ“¤ Step 2: Upload Weights to Server',
    body: 'Each organization sends only its <strong>model weight tensors</strong> to the Federated Server â€” not the raw data. A weight tensor is just a list of numbers representing what the model learned. It contains <strong>zero recoverable information about individual records</strong>. The malicious org also uploads â€” with extreme outlier weights.',
    phase: 'upload'
  },
  {
    title: 'ğŸ›¡ï¸ Step 3: FedMedian Aggregation',
    body: 'The server applies <strong>coordinate-wise median aggregation</strong>. For each weight parameter, it sorts the 4 values and picks the median. The malicious organization\'s extreme values are always at the edge of the sorted list â€” <strong>the median ignores them mathematically</strong>. The result is a clean global model.',
    phase: 'aggregate'
  },
  {
    title: 'ğŸ“¥ Step 4: Download Global Model',
    body: 'The server sends the <strong>clean aggregated global model</strong> back to all trusted organizations. The Bank now has Hospital\'s C2 knowledge. The Hospital now has Bank\'s DDoS knowledge. <strong>The malicious org is excluded</strong> from receiving the global model in our implementation.',
    phase: 'download'
  },
  {
    title: 'ğŸ”„ Step 5: Start Next Round',
    body: 'Each organization uses the global model as a starting point and trains again on their local data. With each round, the global model becomes stronger across all attack domains. <strong>After 5 rounds, the global model achieves 92.9% F1 across all domains</strong> â€” up from 33.3% at round 0.',
    phase: 'done'
  }
];

let currentStep = 0;
let autoInterval = null;
let currentRound = 0;

let _moneyshotCache = [];
let _byzCache = [];
let _byzRoundsCache = [];
let _pipelineMethod = 'fedavg';

function _maxRoundFromRows(rows) {
  const rs = (rows || []).map(x => Number(x.round)).filter(Number.isFinite);
  return rs.length ? Math.max(...rs) : NaN;
}

function getMaxRound() {
  const a = _maxRoundFromRows(_moneyshotCache);
  const b = _maxRoundFromRows(_byzCache);
  const m = Math.max(Number.isFinite(a) ? a : 0, Number.isFinite(b) ? b : 0);
  return Number.isFinite(m) && m > 0 ? m : 5;
}

function setPipelineMethod(v) {
  _pipelineMethod = (v === 'fedmedian') ? 'fedmedian' : 'fedavg';
  updatePipelineMetrics();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE DATA LOADING (CSV)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATA_PATHS = {
  moneyshot: '../results/fedavg_hospital_moneyshot.csv',
  byzantine: '../results/byzantine_defense_history.csv',
  byz_rounds: '../results/byzantine_round_metrics.csv'
};

function _fmtPct(x) {
  if (!Number.isFinite(x)) return 'â€”';
  return `${(x * 100).toFixed(1)}%`;
}

function _fmtDeltaPct(a, b) {
  if (!Number.isFinite(a) || !Number.isFinite(b)) return 'â€”';
  const d = (b - a) * 100;
  const sign = d >= 0 ? '+' : '';
  return `ğŸš€ ${sign}${d.toFixed(1)}% from Round 0`;
}

function _pickNum(obj, keys) {
  for (const k of keys) {
    if (obj && Object.prototype.hasOwnProperty.call(obj, k)) {
      const v = Number(obj[k]);
      if (Number.isFinite(v)) return v;
    }
  }
  return NaN;
}

function updatePipelineMetrics() {
  const maxR = getMaxRound();
  const r = Math.max(0, Math.min(maxR, Number(currentRound)));
  if (r !== currentRound) currentRound = r;

  const msRow = (_moneyshotCache || []).find(x => Number(x.round) === r);
  const byzRow = (_byzCache || []).find(x => Number(x.round) === r);
  const byzClientRow = (_byzRoundsCache || []).find(x => String(x.method) === String(_pipelineMethod) && Number(x.round) === r);

  const elG = document.getElementById('p_global_on_hospital');
  const elB = document.getElementById('p_bank_on_hospital');
  const elH = document.getElementById('p_hospital_on_bank');
  const elP = document.getElementById('p_byzantine_pair');

  if (elG) {
    const v = msRow ? Number(msRow.global_on_hospital_f1) : NaN;
    elG.textContent = _fmtPct(v);
  }
  if (elB) {
    const v = msRow ? Number(msRow.bank_on_hospital_f1) : NaN;
    elB.textContent = _fmtPct(v);
  }
  if (elH) {
    const v = msRow ? Number(msRow.hospital_on_bank_f1) : NaN;
    elH.textContent = _fmtPct(v);
  }
  if (elP) {
    const avg = byzRow ? _pickNum(byzRow, ['fedavg_hospital_f1','fedavg_hospital_f1_y','fedavg_hospital_f1_x']) : NaN;
    const med = byzRow ? _pickNum(byzRow, ['fedmedian_hospital_f1','fedmedian_hospital_f1_y','fedmedian_hospital_f1_x']) : NaN;
    if (Number.isFinite(avg) || Number.isFinite(med)) {
      elP.textContent = `FedAvg ${_fmtPct(avg)}  |  FedMedian ${_fmtPct(med)}`;
    } else {
      elP.textContent = 'â€”';
    }
  }

  const elBC = document.getElementById('p_bank_client');
  const elHC = document.getElementById('p_hospital_client');
  const elTC = document.getElementById('p_tech_client');
  const elMC = document.getElementById('p_malicious_client');
  const elBCS = document.getElementById('p_bank_client_sub');
  const elHCS = document.getElementById('p_hospital_client_sub');
  const elTCS = document.getElementById('p_tech_client_sub');
  const elMCS = document.getElementById('p_malicious_client_sub');

  function fmtLoss(x) {
    const v = Number(x);
    return Number.isFinite(v) ? v.toFixed(4) : 'â€”';
  }
  function fmtF1(x) {
    const v = Number(x);
    return Number.isFinite(v) ? v.toFixed(4) : 'â€”';
  }

  if (byzClientRow) {
    if (elBC) elBC.textContent = `${_pipelineMethod.toUpperCase()} Â· R${r}`;
    if (elBCS) elBCS.textContent = `loss ${fmtLoss(byzClientRow.bank_loss)} Â· f1 ${fmtF1(byzClientRow.bank_f1)}`;
    if (elHC) elHC.textContent = `${_pipelineMethod.toUpperCase()} Â· R${r}`;
    if (elHCS) elHCS.textContent = `loss ${fmtLoss(byzClientRow.hospital_loss)} Â· f1 ${fmtF1(byzClientRow.hospital_f1)}`;
    if (elTC) elTC.textContent = `${_pipelineMethod.toUpperCase()} Â· R${r}`;
    if (elTCS) elTCS.textContent = `loss ${fmtLoss(byzClientRow.tech_loss)} Â· f1 ${fmtF1(byzClientRow.tech_f1)}`;
    if (elMC) elMC.textContent = `${_pipelineMethod.toUpperCase()} Â· R${r}`;
    if (elMCS) elMCS.textContent = `loss ${fmtLoss(byzClientRow.malicious_loss)} Â· f1 ${fmtF1(byzClientRow.malicious_f1)}`;
  } else {
    if (elBC) elBC.textContent = 'â€”';
    if (elBCS) elBCS.textContent = 'loss â€” Â· f1 â€”';
    if (elHC) elHC.textContent = 'â€”';
    if (elHCS) elHCS.textContent = 'loss â€” Â· f1 â€”';
    if (elTC) elTC.textContent = 'â€”';
    if (elTCS) elTCS.textContent = 'loss â€” Â· f1 â€”';
    if (elMC) elMC.textContent = 'â€”';
    if (elMCS) elMCS.textContent = 'loss â€” Â· f1 â€”';
  }
}

function parseCSV(text) {
  const lines = text.replace(/\r/g, '').trim().split('\n').filter(Boolean);
  if (lines.length < 2) return [];
  const header = lines[0].split(',').map(s => s.trim());
  const out = [];
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(',');
    const row = {};
    header.forEach((h, idx) => {
      const raw = (parts[idx] ?? '').trim();
      const num = Number(raw);
      row[h] = Number.isFinite(num) && raw !== '' ? num : raw;
    });
    out.push(row);
  }
  return out;
}

async function fetchCSV(path) {
  const url = `${path}?t=${Date.now()}`;
  const resp = await fetch(url, { cache: 'no-store' });
  if (!resp.ok) throw new Error(`Failed to load ${path}: ${resp.status}`);
  return parseCSV(await resp.text());
}

function _setLiveStatus(msg, isError=false) {
  const el = document.getElementById('liveStatus');
  if (!el) return;
  el.textContent = msg;
  el.style.color = isError ? 'var(--red)' : 'var(--dim)';

  const badge = document.getElementById('liveBadge');
  if (badge) {
    badge.textContent = msg.replace(/^Live status:\s*/,'Live: ');
    badge.style.color = isError ? 'var(--red)' : 'var(--dim)';
    badge.style.borderColor = isError ? 'rgba(255,68,68,.35)' : 'rgba(0,168,255,.25)';
  }
}

function renderResultsChart(rows) {
  const host = document.getElementById('resultsChart');
  if (!host) return;
  if (!rows || rows.length === 0) {
    host.innerHTML = `<div style="color:var(--dim);font-size:12px;font-family:'IBM Plex Mono',monospace;">Waiting for <code>${DATA_PATHS.moneyshot}</code>...</div>`;
    return;
  }

  const rounds = rows.map(r => Number(r.round)).filter(Number.isFinite);
  const maxRound = Math.max(...rounds);
  const ordered = [...rows].sort((a,b) => Number(a.round) - Number(b.round));

  const W = 900;
  const H = 220;
  const x0 = 60;
  const x1 = 880;
  const yTop = 10;
  const yBot = 190;
  const plotH = yBot - yTop;
  const plotW = x1 - x0;

  function xFor(i) {
    if (ordered.length === 1) return x0;
    return x0 + (i / (ordered.length - 1)) * plotW;
  }
  function yFor(val01) {
    const v = Math.max(0, Math.min(1, val01));
    return yBot - v * plotH;
  }
  function pts(key) {
    return ordered.map((r, i) => `${xFor(i).toFixed(1)},${yFor(Number(r[key]) || 0).toFixed(1)}`).join(' ');
  }

  const globalPts = pts('global_on_hospital_f1');
  const bankPts = pts('bank_isolated_f1');
  const hospPts = pts('hospital_isolated_f1');
  const last = ordered[ordered.length - 1];
  const first = ordered[0];

  const xLabels = ordered.map((r, i) => {
    const x = xFor(i);
    return `<text x="${x.toFixed(1)}" y="208" text-anchor="middle" fill="var(--dim)" font-size="11" font-family="monospace">R${Number(r.round)}</text>`;
  }).join('');

  host.innerHTML = `
    <svg class="chart-svg" viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">
      <line x1="${x0}" y1="${yTop}" x2="${x0}" y2="${yBot}" stroke="var(--border)" stroke-width="1"/>
      <line x1="${x0}" y1="${yBot}" x2="${x1}" y2="${yBot}" stroke="var(--border)" stroke-width="1"/>
      <text x="50" y="195" text-anchor="end" fill="var(--dim)" font-size="11" font-family="monospace">0%</text>
      <text x="50" y="145" text-anchor="end" fill="var(--dim)" font-size="11" font-family="monospace">25%</text>
      <text x="50" y="95" text-anchor="end" fill="var(--dim)" font-size="11" font-family="monospace">50%</text>
      <text x="50" y="45" text-anchor="end" fill="var(--dim)" font-size="11" font-family="monospace">75%</text>
      <text x="50" y="18" text-anchor="end" fill="var(--dim)" font-size="11" font-family="monospace">100%</text>
      <line x1="${x0}" y1="145" x2="${x1}" y2="145" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="4,4"/>
      <line x1="${x0}" y1="95" x2="${x1}" y2="95" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="4,4"/>
      <line x1="${x0}" y1="45" x2="${x1}" y2="45" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="4,4"/>
      ${xLabels}

      <polyline points="${globalPts}" fill="none" stroke="var(--teal)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
      <polyline points="${bankPts}" fill="none" stroke="var(--blue)" stroke-width="2" stroke-dasharray="8,4" stroke-linecap="round"/>
      <polyline points="${hospPts}" fill="none" stroke="var(--green)" stroke-width="2" stroke-dasharray="8,4" stroke-linecap="round"/>

      <text x="885" y="20" fill="var(--teal)" font-size="12" font-family="monospace" font-weight="bold">${_fmtPct(Number(last.global_on_hospital_f1))}</text>
      <text x="885" y="43" fill="var(--blue)" font-size="11" font-family="monospace">Bank ${_fmtPct(Number(last.bank_isolated_f1))}</text>
      <text x="885" y="14" fill="var(--green)" font-size="11" font-family="monospace">Hosp ${_fmtPct(Number(last.hospital_isolated_f1))}</text>
      <text x="70" y="127" fill="var(--dim)" font-size="12" font-family="monospace">${_fmtPct(Number(first.global_on_hospital_f1))}</text>
    </svg>
  `;
}

function _statusEmoji(v) {
  if (!Number.isFinite(v)) return 'â€”';
  if (v < 0.4) return { t: 'âŒ Blind spots', c: 'var(--red)' };
  if (v < 0.7) return { t: 'ğŸ”„ Learning', c: 'var(--orange)' };
  if (v < 0.9) return { t: 'ğŸ“ˆ Improving', c: 'var(--yellow)' };
  return { t: 'âœ… Converged', c: 'var(--green)' };
}

function _barCell(val01, color) {
  const pct = _fmtPct(val01);
  const w = Number.isFinite(val01) ? (val01 * 100) : 0;
  return `<div class="f1-bar"><div class="f1-track"><div class="f1-fill" style="width:${w.toFixed(1)}%;background:${color}"></div></div><span style="font-family:monospace;color:${color};font-weight:700">${pct}</span></div>`;
}

function renderRoundsTable(rows) {
  const tbody = document.getElementById('resultsRoundsBody');
  if (!tbody) return;
  if (!rows || rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" style="color:var(--dim);font-family:'IBM Plex Mono',monospace;font-size:12px;padding:16px 18px;">Waiting for <code>${DATA_PATHS.moneyshot}</code>...</td></tr>`;
    return;
  }

  const ordered = [...rows].sort((a,b) => Number(a.round) - Number(b.round));
  tbody.innerHTML = ordered.map(r => {
    const round = Number(r.round);
    const bankOnHosp = Number(r.bank_on_hospital_f1);
    const hospOnBank = Number(r.hospital_on_bank_f1);
    const globalAll = Number(r.global_on_hospital_f1);
    const status = _statusEmoji(globalAll);

    const bankColor = bankOnHosp < 0.4 ? 'var(--red)' : (bankOnHosp < 0.7 ? 'var(--orange)' : (bankOnHosp < 0.9 ? 'var(--yellow)' : 'var(--green)'));
    const hospColor = hospOnBank < 0.4 ? 'var(--red)' : (hospOnBank < 0.7 ? 'var(--orange)' : (hospOnBank < 0.9 ? 'var(--yellow)' : 'var(--green)'));
    const globalColor = globalAll < 0.4 ? 'var(--red)' : (globalAll < 0.7 ? 'var(--orange)' : (globalAll < 0.9 ? 'var(--yellow)' : 'var(--green)'));

    return `
      <tr>
        <td><span class="round-badge">Round ${round}</span></td>
        <td>${_barCell(bankOnHosp, bankColor)}</td>
        <td>${_barCell(hospOnBank, hospColor)}</td>
        <td>${_barCell(globalAll, globalColor)}</td>
        <td style="color:${status.c};font-size:12px">${status.t}</td>
      </tr>
    `;
  }).join('');
}

function updateResultCards(rows) {
  if (!rows || rows.length === 0) return;
  const ordered = [...rows].sort((a,b) => Number(a.round) - Number(b.round));
  const first = ordered[0];
  const last = ordered[ordered.length - 1];

  const bank0 = Number(first.bank_on_hospital_f1);
  const bankN = Number(last.bank_on_hospital_f1);
  const global0 = Number(first.global_on_hospital_f1);
  const globalN = Number(last.global_on_hospital_f1);
  const hosp0 = Number(first.hospital_on_bank_f1);
  const hospN = Number(last.hospital_on_bank_f1);

  const elBank0 = document.getElementById('m_bank_on_hospital_r0');
  const elBankN = document.getElementById('m_bank_on_hospital_rN');
  const elGlobalN = document.getElementById('m_global_all_rN');
  const elGlobalD = document.getElementById('m_global_all_delta');
  const elHospN = document.getElementById('m_hosp_on_bank_rN');
  const elHospD = document.getElementById('m_hosp_on_bank_delta');

  if (elBank0) elBank0.textContent = _fmtPct(bank0);
  if (elBankN) elBankN.textContent = _fmtPct(bankN);
  if (elGlobalN) elGlobalN.textContent = _fmtPct(globalN);
  if (elGlobalD) elGlobalD.textContent = _fmtDeltaPct(global0, globalN);
  if (elHospN) elHospN.textContent = _fmtPct(hospN);
  if (elHospD) elHospD.textContent = `â†‘ ${( (hospN - hosp0) * 100).toFixed(1)}% over Round 0`;
}

function updateByzantineCards(rows) {
  const elAvg = document.getElementById('b_fedavg_final');
  const elMed = document.getElementById('b_fedmedian_final');
  if (!elAvg || !elMed) return;
  if (!rows || rows.length === 0) {
    elAvg.textContent = 'â€”';
    elMed.textContent = 'â€”';
    return;
  }
  const ordered = [...rows].sort((a,b) => Number(a.round) - Number(b.round));
  const last = ordered[ordered.length - 1];

  function pickNum(obj, keys) {
    for (const k of keys) {
      if (obj && Object.prototype.hasOwnProperty.call(obj, k)) {
        const v = Number(obj[k]);
        if (Number.isFinite(v)) return v;
      }
    }
    return NaN;
  }

  const avg = pickNum(last, ['fedavg_hospital_f1','fedavg_hospital_f1_y','fedavg_hospital_f1_x']);
  const med = pickNum(last, ['fedmedian_hospital_f1','fedmedian_hospital_f1_y','fedmedian_hospital_f1_x']);
  elAvg.textContent = _fmtPct(avg);
  elMed.textContent = _fmtPct(med);
}

async function refreshLiveData() {
  const t0 = Date.now();
  let moneyshotRows = [];
  let byzRows = [];

  let moneyshotOk = false;
  let byzOk = false;
  let moneyshotErr = '';
  let byzErr = '';

  try {
    moneyshotRows = await fetchCSV(DATA_PATHS.moneyshot);
    _moneyshotCache = moneyshotRows;
    updateResultCards(moneyshotRows);
    renderResultsChart(moneyshotRows);
    renderRoundsTable(moneyshotRows);
    moneyshotOk = true;
  } catch (e) {
    renderResultsChart([]);
    renderRoundsTable([]);
    moneyshotErr = (e && e.message) ? e.message : String(e);
  }

  try {
    byzRows = await fetchCSV(DATA_PATHS.byzantine);
    _byzCache = byzRows;
    updateByzantineCards(byzRows);
    byzOk = true;
  } catch (e) {
    updateByzantineCards([]);
    byzErr = (e && e.message) ? e.message : String(e);
  }

  try {
    const byzRounds = await fetchCSV(DATA_PATHS.byz_rounds);
    _byzRoundsCache = byzRounds;
  } catch (e) {
    _byzRoundsCache = [];
  }

  const ms = Date.now() - t0;
  const now = new Date();

  if (!moneyshotOk && !byzOk) {
    _setLiveStatus(`Live status: ERROR Â· ${now.toLocaleTimeString()} Â· moneyshot failed (${DATA_PATHS.moneyshot}): ${moneyshotErr} Â· byzantine failed (${DATA_PATHS.byzantine}): ${byzErr}`, true);
    return;
  }

  if (!moneyshotOk) {
    _setLiveStatus(`Live status: PARTIAL Â· ${now.toLocaleTimeString()} Â· moneyshot failed (${DATA_PATHS.moneyshot}): ${moneyshotErr} Â· byzantine rows=${byzRows.length} Â· refresh=${ms}ms`, true);
    return;
  }

  if (!byzOk) {
    _setLiveStatus(`Live status: PARTIAL Â· ${now.toLocaleTimeString()} Â· moneyshot rows=${moneyshotRows.length} Â· byzantine failed (${DATA_PATHS.byzantine}): ${byzErr} Â· refresh=${ms}ms`, true);
    return;
  }

  _setLiveStatus(`Live status: OK Â· ${now.toLocaleTimeString()} Â· moneyshot rows=${moneyshotRows.length} Â· byzantine rows=${byzRows.length} Â· refresh=${ms}ms`);
  updatePipelineMetrics();
}

let _pollHandle = null;
function startPolling() {
  if (_pollHandle) return;
  _pollHandle = setInterval(refreshLiveData, 5000);
}

function buildDots() {
  const container = document.getElementById('stepDots');
  container.innerHTML = '';
  STEPS.forEach((_, i) => {
    const d = document.createElement('div');
    d.className = 'dot' + (i === 0 ? ' active' : '');
    d.onclick = () => goToStep(i);
    container.appendChild(d);
  });
}

function resetAll() {
  ['bank','hosp','tech','evil'].forEach(id => {
    const el = document.getElementById('org-' + id);
    const elr = document.getElementById('org-' + id + '-r');
    el.className = 'org-card ' + id;
    if (elr) elr.className = 'org-card ' + id;
    if (id === 'evil') { el.className = 'org-card evil'; if(elr) elr.style.opacity = '0.3'; }
  });
  document.getElementById('status-bank').textContent = 'IDLE';
  document.getElementById('status-hosp').textContent = 'IDLE';
  document.getElementById('status-tech').textContent = 'IDLE';
  document.getElementById('status-evil').textContent = 'POISONED';
  document.getElementById('status-bank-r').textContent = 'WAITING';
  document.getElementById('status-hosp-r').textContent = 'WAITING';
  document.getElementById('status-tech-r').textContent = 'WAITING';
  document.getElementById('status-evil-r').textContent = 'EXCLUDED';

  const server = document.getElementById('server-card');
  server.classList.remove('aggregating');
  document.getElementById('server-status').textContent = 'Waiting for weights...';
  document.getElementById('server-badge').className = 'server-badge';
  document.getElementById('server-badge').textContent = 'FedMedian';

  document.getElementById('left-flow').classList.remove('flowing');
  document.getElementById('right-flow').style.opacity = '0';
  document.getElementById('right-flow').classList.remove('flowing');
  document.getElementById('evil-flow').style.display = 'none';
}

function applyStep(step) {
  resetAll();
  const s = STEPS[step];
  document.getElementById('stepTitle').textContent = s.title;
  document.getElementById('stepBody').innerHTML = s.body;
  document.getElementById('roundInfo').textContent = `Round ${currentRound} Â· Step ${step+1}/5`;
  updatePipelineMetrics();

  const dots = document.querySelectorAll('.dot');
  dots.forEach((d, i) => {
    d.classList.remove('active','done');
    if (i < step) d.classList.add('done');
    if (i === step) d.classList.add('active');
  });

  if (s.phase === 'train') {
    ['bank','hosp','tech'].forEach(id => {
      const el = document.getElementById('org-' + id);
      el.classList.add('sending');
      document.getElementById('status-' + id).textContent = 'TRAINING...';
    });
    document.getElementById('org-evil').classList.add('sending');
    document.getElementById('status-evil').textContent = 'POISONING...';
  }

  if (s.phase === 'upload') {
    document.getElementById('left-flow').classList.add('flowing');
    document.getElementById('evil-flow').style.display = 'block';
    document.getElementById('left-flow').style.opacity = '0.8';
    document.getElementById('left-label').textContent = 'weights â†’';
    document.getElementById('server-status').textContent = 'Receiving weights...';
    ['bank','hosp','tech'].forEach(id => {
      document.getElementById('org-' + id).classList.add('sending');
      document.getElementById('status-' + id).textContent = 'UPLOADING...';
    });
  }

  if (s.phase === 'aggregate') {
    const server = document.getElementById('server-card');
    server.classList.add('aggregating');
    document.getElementById('server-status').textContent = 'Running FedMedian...';
    document.getElementById('server-badge').className = 'server-badge warning';
    document.getElementById('server-badge').textContent = 'â˜ ï¸ Malicious FILTERED';
    document.getElementById('left-flow').style.opacity = '0.2';
    ['bank','hosp','tech'].forEach(id => {
      document.getElementById('status-' + id).textContent = 'WAITING...';
    });
    document.getElementById('org-evil').classList.add('blocked');
    document.getElementById('status-evil').textContent = 'BLOCKED';
  }

  if (s.phase === 'download') {
    document.getElementById('right-flow').style.opacity = '0.8';
    document.getElementById('right-flow').classList.add('flowing');
    document.getElementById('right-label').textContent = 'â† global model';
    document.getElementById('server-status').textContent = 'Distributing global model';
    document.getElementById('server-badge').textContent = 'âœ… Clean Model';
    document.getElementById('server-badge').className = 'server-badge';
    ['bank','hosp','tech'].forEach(id => {
      document.getElementById('org-' + id + '-r').classList.add('receiving');
      document.getElementById('status-' + id + '-r').textContent = 'RECEIVING...';
    });
    document.getElementById('org-evil-r').style.opacity = '0.2';
  }

  if (s.phase === 'done') {
    document.getElementById('right-flow').style.opacity = '0.5';
    document.getElementById('server-status').textContent = 'Round complete âœ…';
    document.getElementById('server-badge').textContent = 'Next Round Ready';
    ['bank','hosp','tech'].forEach(id => {
      document.getElementById('org-' + id + '-r').classList.add('receiving');
      document.getElementById('status-' + id + '-r').textContent = 'UPDATED âœ…';
    });
  }
}

function goToStep(step) {
  currentStep = Math.max(0, Math.min(STEPS.length - 1, step));
  applyStep(currentStep);
}

function nextStep() {
  if (currentStep >= STEPS.length - 1) {
    currentRound = Math.min(getMaxRound(), currentRound + 1);
    currentStep = 0;
  } else {
    currentStep++;
  }
  applyStep(currentStep);
}

function prevStep() {
  if (currentStep <= 0) {
    currentRound = Math.max(0, currentRound - 1);
    currentStep = STEPS.length - 1;
  } else {
    currentStep--;
  }
  applyStep(currentStep);
}

function autoPlay() {
  const btn = document.getElementById('playBtn');
  if (autoInterval) {
    clearInterval(autoInterval);
    autoInterval = null;
    btn.textContent = 'â–¶ Auto Play';
    btn.classList.add('play');
    return;
  }
  btn.textContent = 'â¸ Pause';
  btn.classList.remove('play');
  autoInterval = setInterval(() => {
    nextStep();
    if (currentStep === STEPS.length - 1 && currentRound === getMaxRound()) {
      clearInterval(autoInterval);
      autoInterval = null;
      btn.textContent = 'â–¶ Auto Play';
      btn.classList.add('play');
    }
  }, 2200);
}

// Init
buildDots();
applyStep(0);
window.addEventListener('DOMContentLoaded', () => {
  refreshLiveData();
  startPolling();
});
</script>
</body>
</html>
